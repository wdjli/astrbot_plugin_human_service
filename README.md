
<div align="center">

![:name](https://count.getloli.com/@astrbot_plugin_human_service?name=astrbot_plugin_human_service&theme=minecraft&padding=6&offset=0&align=top&scale=1&pixelated=1&darkmode=auto)

# astrbot_plugin_human_service

_✨ [astrbot](https://github.com/AstrBotDevs/AstrBot) 人工客服插件 ✨_  

[![License](https://img.shields.io/badge/License-MIT-green.svg)](https://opensource.org/licenses/MIT)
[![Python 3.10+](https://img.shields.io/badge/Python-3.10%2B-blue.svg)](https://www.python.org/)
[![AstrBot](https://img.shields.io/badge/AstrBot-4.3.3-orange.svg)](https://github.com/Soulter/AstrBot)
[![GitHub](https://img.shields.io/badge/作者-Zhalslar-blue)](https://github.com/Zhalslar)

</div>

## 🤝 介绍

让bot转人工\转人机，管理员接入对话\结束对话

## ✨ 新功能特性（v1.7.2）

### 🔇 活动沉默模式
- **独占模式**：开启后，机器人的AI对话和其他插件功能将全部停止
- **仅保留人工客服**：只有人工客服插件的命令可以使用
- **适用场景**：
  - 纯人工客服场景
  - 维护期间只开放人工服务
  - 防止AI和人工客服冲突
- **智能判断**：
  - 允许所有人工客服命令
  - 允许正在对话的用户消息
  - 允许客服的所有消息
  - 阻止其他所有消息传播到AI或其他插件

### 🌍 智能翻译系统（v1.7.0）
- **AI翻译**：基于OpenAI API的智能翻译，支持中英日三语
- **双向翻译**：自动翻译客服和用户之间的消息
- **原文+译文**：同时发送原文和翻译，确保信息准确
- **智能判断**：只翻译纯文本消息，图片、表情等保持原样
- **翻译测试**：客服可使用 `/翻译测试` 命令测试翻译功能是否正常
- **翻译方向**：
  - 客服→用户：翻译为目标语言
  - 用户→客服：翻译为主语言
- **配置灵活**：
  - 支持自定义OpenAI API地址（可使用代理）
  - 可选择主语言和目标语言
  - 可选择使用的AI模型
- **示例效果**：
  - 主语言：中文，目标语言：英文
  - 用户发送：`"Hello"`
  - 客服收到：`"Hello"` + `"[翻译] 你好"`
  - 客服回复：`"你好"`
  - 用户收到：`"你好"` + `"[翻译] Hello"`

### 🎲 答非所问模式（v1.6.4）
- **娱乐功能**：开启后客服的消息会被替换成随机组合的自定义文字
- **自定义文字**：可配置用于组合的文字（例如：`"哈基米"`）
- **智能生成**：根据原消息长度生成相应长度的随机文字（50%-150%）
- **示例效果**：
  - 自定义文字：`"哈基米"`
  - 客服输入：`"是的，你说的对"`
  - 用户收到：`"哈基米哈"`、`"基米哈基"`等随机组合
- **只替换文本**：只对纯文本消息生效，图片、表情等富媒体消息保持原样
- **娱乐功能**：建议仅用于娱乐场景，慎用于正式客服！

### 💬 自定义消息前缀/后缀（v1.6.3）
- **个性化前后缀**：为客服消息添加自定义前缀和后缀，让对话更加亲切
- **灵活配置**：可以设置任意文本作为前缀或后缀
  - 前缀示例：`"亲"`、`"您好~"`
  - 后缀示例：`"~"`、`"哦"`、`"呢"`
- **智能添加**：自动在客服发送的纯文本消息前后添加
- **智能识别**：只对纯文本消息添加，图片、表情、文件等富媒体消息不添加
- **示例效果**：
  - 前缀设置为 `"亲"`，后缀设置为 `"~"`
  - 客服输入：`"你好"`
  - 用户收到：`"亲你好~"`
  - 客服发送图片：用户收到原图片（不添加前后缀）
- **可选功能**：留空则不添加，保持原样
- **注意**：答非所问模式启用时，前后缀功能会被答非所问替代

### 📖 智能帮助系统（v1.6.2）
- **命令帮助**：使用 `/kfhelp` 命令查看所有可用命令
- **智能识别**：根据身份显示不同内容
  - 用户：只显示用户可用的命令
  - 客服：显示所有命令和当前配置信息
- **详细说明**：每个命令都有清晰的使用说明和示例

## ✨ 功能特性（v1.6.1）

### 🚫 黑名单功能
- **拉黑用户**：客服可以使用 `/拉黑 QQ号` 命令拉黑骚扰用户（例如：`/拉黑 123456`）
- **取消拉黑**：客服可以使用 `/取消拉黑 QQ号` 命令解除拉黑（例如：`/取消拉黑 123456`）
- **查看黑名单**：客服可以使用 `/查看黑名单` 命令查看黑名单列表
  - 显示用户昵称和QQ号
  - 共用黑名单或单客服时直接显示所有黑名单
  - 独立黑名单时可选择查看指定客服的黑名单
- **共用黑名单**：可配置多客服是否共用黑名单
  - 开启共用：一个客服拉黑，所有客服都无法接待该用户
  - 关闭共用：每个客服有独立黑名单，互不影响
- **智能过滤**：被拉黑用户无法转人工，在客服选择列表中不显示已拉黑该用户的客服

### 👤 客服名称显示（v1.6.0）
- **客服名称配置**：可以为每个客服配置名称，用户可以看到客服的名字
- **友好的显示**：在客服选择列表、接入提示、聊天记录等地方显示客服名称
- **向后兼容**：支持旧的配置方式（QQ号列表），无需修改现有配置

### ⏰ 时间管理系统（v1.5.0）
- **对话时间限制**：可配置单次对话的最大时长（秒），超时自动结束对话
- **排队时间限制**：可配置用户最大排队等待时长（秒），超时自动移出队列
- **超时提前提醒**：在对话即将超时前自动提醒用户和客服
- **自动接入下一位**：对话超时后自动从队列接入下一位用户
- **灵活配置**：所有时间限制都是可选的，设置为0表示不限制

### 🎯 智能队列系统（v1.4.0）
- **防止客服同时服务多人**：客服同一时间只能服务一个用户，保证服务质量
- **自动排队管理**：当客服忙碌时，用户自动加入排队队列
- **实时状态显示**：客服选择界面显示客服状态（空闲🟢/忙碌🔴）和排队人数
- **自动接入下一位**：客服结束对话后，系统自动准备接入队列中的下一位用户
- **队列查询**：用户可随时查看自己的排队位置
- **灵活退出**：用户可以随时取消排队，不影响其他用户

## 📦 安装（此为魔改源码，且并没有并入主分支，此安装方式无效）

- 可以直接在astrbot的插件市场搜索 `astrbot_plugin_human_service`，点击安装，耐心等待安装完成即可
- 若是安装失败，可以尝试直接克隆源码：

```bash
# 克隆仓库到插件目录
cd /AstrBot/data/plugins
git clone https://github.com/Zhalslar/astrbot_plugin_human_service

# 控制台重启AstrBot
```

## ⌨️ 使用说明

### 命令表

|     命令      |                    说明                    |      使用者      |
|:-------------:|:---------------------------------------------:|:----------------:|
| `/转人工`     | 用户请求转人工。如果配置了多个客服且启用了客服选择功能，会显示客服列表供用户选择；否则会通知所有客服等待接入。如果客服正在服务中，会自动加入排队。 | 用户 |
| `/转人机`     | 用户取消转人工请求或客服选择，结束等待状态。也可以退出排队。     | 用户 |
| `/取消排队`   | 用户主动退出排队队列。 | 用户 |
| `/排队状态`   | 查看当前在队列中的位置和排队人数。 | 用户 |
| `/kfhelp`     | 显示帮助信息。根据身份显示不同内容：用户看到用户命令，客服看到全部命令。 | 全部 |
| `/接入对话`   | 客服接入用户的对话，开始人工服务。通过回复用户的请求消息使用此命令。 | 客服 |
| `/拒绝接入`   | 客服拒绝用户的接入请求。通过回复用户的请求消息使用此命令。 | 客服 |
| `/拉黑`       | 客服拉黑用户，被拉黑用户无法使用人工客服。使用格式：`/拉黑 QQ号`，例如：`/拉黑 123456` | 客服 |
| `/取消拉黑`   | 客服取消拉黑用户。使用格式：`/取消拉黑 QQ号`，例如：`/取消拉黑 123456` | 客服 |
| `/查看黑名单` | 客服查看黑名单列表。共用黑名单或单客服时直接显示；独立黑名单时需选择要查看的客服。 | 客服 |
| `/翻译测试`   | 客服测试翻译功能是否正常工作。会调用API进行测试翻译，返回成功或失败。 | 客服 |
| `/导出记录`   | 导出当前会话的聊天记录（需启用聊天记录功能）。以QQ聊天记录格式发送。 | 客服 |
| `/结束对话`   | 客服结束当前对话，关闭会话。如果队列中有等待的用户，会自动准备接入下一位。 | 客服 |

### 配置说明

插件支持以下配置项（在插件配置页面设置）：

#### 基础配置

1. **客服QQ号列表** (`servicers_id`)
   - 类型：列表
   - 格式：`["123456789", "987654321", "555666777"]`
   - 说明：填写客服的QQ号列表
   - 如果不填，默认使用全局配置中的管理员作为客服

1.1. **客服名称列表** (`servicers_names`) - 可选 ⭐
   - 类型：列表
   - 格式：`["客服小王", "客服小李", "客服小张"]`
   - 说明：填写客服的名称，顺序对应 `servicers_id`。用户可以看到客服名称
   - 如果不填或数量不够，对应的客服将显示QQ号
   - 示例：如果 `servicers_id` 是 `["123456789", "987654321"]`，则 `servicers_names` 是 `["客服小王", "客服小李"]`

2. **启用客服选择功能** (`enable_servicer_selection`)
   - 类型：布尔值（true/false）
   - 默认：true
   - 说明：当有多个客服时，是否让用户选择对接哪个客服

3. **启用聊天记录功能** (`enable_chat_history`)
   - 类型：布尔值（true/false）
   - 默认：false
   - 说明：开启后，客服可以使用 `/导出记录` 命令导出当前会话的聊天记录

3.1. **启用活动沉默模式** (`enable_silence_mode`) - v1.7.2新增 ⭐
   - 类型：布尔值（true/false）
   - 默认：false
   - 说明：开启后，机器人的AI对话和其他插件功能将全部停止，仅保留人工客服插件功能
   - 适用场景：纯人工客服模式、维护期间、防止AI干扰
   - 效果：用户只能使用人工客服命令，其他消息不会被AI或其他插件处理

3.2. **共用黑名单** (`share_blacklist`) 
   - 类型：布尔值（true/false）
   - 默认：true
   - 说明：多客服模式下，是否共用黑名单
   - 开启：一个客服拉黑用户，所有客服都无法接待该用户
   - 关闭：每个客服有独立的黑名单，互不影响

3.3. **客服消息前缀** (`message_prefix`) 
   - 类型：字符串
   - 默认：空（不添加前缀）
   - 说明：客服发送给用户的纯文本消息前缀，让对话更加亲切
   - 只对纯文本消息添加前缀，图片、表情、文件等富媒体消息不添加
   - 示例：设置为 `"亲"` 后，客服发送 `"你好"`，用户收到 `"亲你好"`
   - 留空则不添加前缀
   - 注意：答非所问模式启用时，此功能会被答非所问替代

3.3.1. **客服消息后缀** (`message_suffix`) 
   - 类型：字符串
   - 默认：空（不添加后缀）
   - 说明：客服发送给用户的纯文本消息后缀，让对话更加亲切
   - 只对纯文本消息添加后缀，图片、表情、文件等富媒体消息不添加
   - 示例：设置为 `"~"` 后，客服发送 `"你好"`，用户收到 `"你好~"`
   - 可与前缀同时使用，例如前缀 `"亲"`+后缀 `"~"`，用户收到 `"亲你好~"`
   - 留空则不添加后缀
   - 注意：答非所问模式启用时，此功能会被答非所问替代

3.4. **启用答非所问模式** (`enable_random_reply`) 
   - 类型：布尔值（true/false）
   - 默认：false
   - 说明：开启后，客服的纯文本消息会被替换成自定义文字的随机组合
   - 娱乐功能，建议仅用于娱乐场景

3.5. **答非所问自定义文字** (`random_reply_chars`) - v1.8.0新增
   - 类型：字符串
   - 默认：`"哈基米"`
   - 说明：用于答非所问模式的文字，系统会随机组合这些字
   - 示例：设置为 `"哈基米"` 后，可能生成 `"哈基"`、`"米哈基"`、`"基米哈"`等

#### 🌍 智能翻译配置（v1.7.0新增）

3.6. **启用智能翻译** (`enable_translation`) 
   - 类型：布尔值（true/false）
   - 默认：false
   - 说明：开启后，系统会自动翻译客服与用户之间的消息
   - 需要配置OpenAI API Key才能使用

3.7. **主语言** (`translation_main_language`) 
   - 类型：字符串
   - 默认：`"中文"`
   - 可选值：`"中文"`、`"英文"`、`"日文"`
   - 说明：主要使用的语言。双方都使用主语言时不翻译

3.8. **需翻译语言** (`translation_target_language`) 
   - 类型：字符串
   - 默认：`"英文"`
   - 可选值：`"中文"`、`"英文"`、`"日文"`
   - 说明：需要翻译的目标语言

3.9. **OpenAI API Key** (`openai_api_key`) 
   - 类型：字符串
   - 默认：空
   - 说明：用于智能翻译的OpenAI API Key
   - 格式：`sk-xxx`
   - 留空则无法使用翻译功能

3.10. **OpenAI API 地址** (`openai_base_url`) 
   - 类型：字符串
   - 默认：`"https://api.openai.com/v1"`
   - 说明：OpenAI API的基础URL
   - 如使用代理或第三方服务（如one-api），可修改此地址

3.11. **翻译模型** (`openai_model`) 
   - 类型：字符串
   - 默认：`"gpt-3.5-turbo"`
   - 说明：用于翻译的OpenAI模型
   - 可选值：`gpt-3.5-turbo`、`gpt-4`、`gpt-4-turbo`等
   - 推荐：`gpt-3.5-turbo`（速度快、成本低）

#### ⏰ 时间限制配置

4. **对话时间限制** (`conversation_timeout`)
   - 类型：整数（秒）
   - 默认：0（不限制）
   - 说明：单次对话的最大时长。设置为0表示不限制。超时后会自动结束对话并接入下一位
   - 示例：设置为1800表示每次对话最多1800秒（30分钟）

5. **排队时间限制** (`queue_timeout`)
   - 类型：整数（秒）
   - 默认：0（不限制）
   - 说明：用户最大排队等待时长。设置为0表示不限制。超时后会自动移出队列并通知用户
   - 示例：设置为900表示最多排队900秒（15分钟）

6. **超时提前提醒** (`timeout_warning_seconds`)
   - 类型：整数（秒）
   - 默认：120
   - 说明：在对话即将超时前多少秒提醒。设置为0表示不提醒。仅在设置了对话时间限制时有效
   - 示例：设置为180表示对话结束前180秒（3分钟）会提醒用户和客服

### 使用流程

#### 单客服模式
1. 用户发送 `/转人工`
2. 系统检查客服状态：
   - 如果客服空闲：通知客服有用户请求
   - 如果客服忙碌：将用户加入排队队列，显示排队位置
3. 客服使用 `/接入对话` 接入
4. 开始双向消息转发
5. 客服使用 `/结束对话` 结束会话
6. 如果队列中有等待用户，系统自动准备接入下一位

#### 多客服选择模式
1. 用户发送 `/转人工`
2. 系统显示客服列表（包含客服状态：空闲🟢/忙碌🔴，以及排队人数）
3. 用户回复序号选择客服
4. 系统检查客服状态：
   - 如果客服空闲：通知客服有用户请求
   - 如果客服忙碌：将用户加入该客服的排队队列
5. 客服使用 `/接入对话` 接入
6. 开始双向消息转发
7. 客服使用 `/结束对话` 结束会话
8. 如果队列中有等待用户，系统自动准备接入下一位

#### 队列管理
- 用户可以使用 `/排队状态` 查看当前排队位置
- 用户可以使用 `/取消排队` 或 `/转人机` 退出队列
- 客服结束对话后，队列中的下一位用户会自动准备接入
- 客服会收到队列状态提示

#### ⏰ 时间限制（可选功能）
- **对话开始时**：如果配置了对话时间限制，用户和客服都会收到时间提示
- **对话进行中**：系统自动检查时间，临近超时时会提前提醒
- **对话超时**：自动结束对话，通知双方，并自动接入队列中的下一位用户
- **排队超时**：超过排队时间限制的用户会自动移出队列并收到通知

**注意**：
- 用户在任何阶段都可以使用 `/转人机` 或 `/取消排队` 取消请求
- 时间限制功能是可选的，默认不限制（配置为0）
- 建议根据实际客服工作负载合理设置时间限制

### 示例图

![c4c33c6e4ea7687165880e0c55eacd2](https://github.com/user-attachments/assets/4024faae-3932-4c63-9ceb-b72f785fbb03)

## 👥 贡献指南

- 🌟 Star 这个项目！（点右上角的星星，感谢支持！）
- 🐛 提交 Issue 报告问题
- 💡 提出新功能建议
- 🔧 提交 Pull Request 改进代码

## 📌 注意事项

- 想第一时间得到反馈的可以来作者的插件反馈群（QQ群）：460973561（不点star不给进）
